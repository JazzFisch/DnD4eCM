//var debugJson = '{"CompendiumUrl":"http://www.wizards.com/dndinsider/compendium/monster.aspx?id=363","Description":"","GroupRole":"Solo","IsLeader":true,"Items":[{"Key":"Wand of Orcus","Value":1}],"Keywords":["Demon"],"Immunities":["Disease","Poison","Necrotic"],"Origin":"Elemental","OtherSpeeds":["Fly 10 (clumsy)","Teleport 6"],"Phasing":false,"Powers":[{"Action":"Standard","Attacks":[{"AttackBonuses":{"AC":37},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"2d12 + 12","Description":"damage plus 1d12 necrotic damage, and the target is weakened (save ends)","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":"Reach 4","Targets":null}],"Flavor":null,"IsBasic":true,"Keywords":["Necrotic","Weapon"],"Name":"Wand of Orcus","Requirements":null,"Trigger":null,"Type":"Melee","Usage":"At-Will","UsageDetails":null},{"Action":"Standard","Attacks":[{"AttackBonuses":{"Fortitude":33},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"the target is reduced to 0 hit points (resistance or immunity to necrotic damage does not apply).","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"The target takes necrotic damage equal to its bloodied value","FailedSavingThrows":[],"IsEmpty":false,"Name":"Miss","Sustains":[]},"Range":"Reach 4","Targets":null}],"Flavor":null,"IsBasic":false,"Keywords":["Necrotic"],"Name":"Touch of Death","Requirements":null,"Trigger":null,"Type":"Melee","Usage":"Recharge","UsageDetails":"6"},{"Action":"Immediate Interrupt","Attacks":[{"AttackBonuses":{"AC":36},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"2d8 + 12","Description":"damage, and the target is stunned until the end of Orcus’s next turn and is knocked prone","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":null,"Targets":null}],"Flavor":null,"IsBasic":false,"Keywords":[],"Name":"Tail Lash","Requirements":null,"Trigger":"when an enemy moves or shifts into a square adjacent to Orcus","Type":"Melee","Usage":"At-Will","UsageDetails":null},{"Action":"Standard","Attacks":[{"AttackBonuses":{"Fortitude":38},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"2d12 + 12","Description":"necrotic damage, and all undead in the burst regain 20 hit points","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":"Close burst 10","Targets":null}],"Flavor":null,"IsBasic":false,"Keywords":["Healing","Necrotic"],"Name":"Necrotic Burst","Requirements":null,"Trigger":null,"Type":"Close","Usage":"Recharge","UsageDetails":"6"}],"Regeneration":0,"Resistances":["20 variable (3/encounter)"],"Role":"Brute","SavingThrows":5,"Senses":[{"Key":"low-light vision","Value":0},{"Key":"Darkvision","Value":0}],"SourceBook":"Monster Manual 1","SourceBooks":null,"Tactics":"Those unfortunate enough to meet Orcus rarely survive the experience. The demon lord surrounds himself with undead guards and minions, and eagerly meets any challenge to battle. He likes to crush foes with the Wand of Orcus and uses master of undeath to make dread wraiths out of those he slays. Against a particularly trouble foe, he uses touch of death. When an enemy moves into an adjacent square, the demon lord strikes with his spined tail. When surrounded by numerous foes, he spends an action point to use necrotic burst.","Traits":[{"Name":"Aura of Death","Details":"enemies that enter or start their turns in the aura take 10 necrotic damage (20 necrotic damage while Orcus is bloodied).","Keywords":["Necrotic"],"Range":20},{"Name":"The Dead Rise","Details":"enemies (including flying ones) treat the area within the aura as difficult terrain, and any dead creature within the aura at the start of Orcus’s turn (except those killed by the Wand of Orcus) rises as an abyssal ghoul myrmidon to fight at Orcus’s command.","Keywords":[],"Range":6},{"Name":"Master of Undeath","Details":"At the start of Orcus’s turn, any creature killed by the Wand of Orcus that is still dead rises as a dread wraith under Orcus’s command.","Keywords":[],"Range":0}],"Type":"Humanoid","Weaknesses":[],"AbilityScores":{"Strength":35,"Constitution":33,"Dexterity":22,"Intelligence":25,"Wisdom":25,"Charisma":30},"ActionPoints":2,"Alignment":"ChaoticEvil","Defenses":{"AC":48,"Fortitude":51,"Reflex":46,"Will":49},"Experience":155000,"Handle":"Orcus (Br33S)","HitPoints":1525,"Initiative":22,"Speed":6,"Languages":["Abyssal"],"Level":33,"Name":"Orcus","Race":null,"Skills":{"Arcana":28,"History":28,"Intimidate":31,"Religion":28,"Perception":28},"Size":"Gargantuan"}';
var debugJson = '{"CompendiumUrl":"http://www.wizards.com/dndinsider/compendium/monster.aspx?id=2909","Description":"","GroupRole":"Solo","IsLeader":false,"Items":[],"Keywords":["Dragon"],"Immunities":[],"Origin":"Natural","OtherSpeeds":["Fly 8 (hover)","Overland Flight 12"],"Phasing":false,"Powers":[{"Action":"Standard","Attacks":[{"AttackBonuses":{"AC":18},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"3d6 + 6","Description":"damage","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":"Reach 2","Targets":null}],"Flavor":null,"IsBasic":true,"Keywords":[],"Name":"Bite","Requirements":null,"Trigger":null,"Type":"Melee","Usage":"At-Will","UsageDetails":null},{"Action":"Standard","Attacks":[{"AttackBonuses":{"AC":18},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"2d6 + 6","Description":"damage","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":"Reach 2","Targets":null}],"Flavor":null,"IsBasic":true,"Keywords":[],"Name":"Claw","Requirements":null,"Trigger":null,"Type":"Melee","Usage":"At-Will","UsageDetails":null},{"Action":"Standard","Attacks":[{"AttackBonuses":{},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"The adult silver dragon makes a claw attack against each enemy within reach.","FailedSavingThrows":[],"IsEmpty":false,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":null,"Targets":null}],"Flavor":null,"IsBasic":false,"Keywords":[],"Name":"Dragon Onslaught","Requirements":null,"Trigger":null,"Type":"Melee","Usage":"At-Will","UsageDetails":null},{"Action":"Immediate Reaction","Attacks":[{"AttackBonuses":{"AC":18},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"1d8 + 9","Description":"damage","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":"Reach 2","Targets":"targets the triggering enemy and an enemy flanking with the triggering enemy"}],"Flavor":null,"IsBasic":false,"Keywords":[],"Name":"Wing Slice","Requirements":null,"Trigger":"when an enemy attacks the adult silver dragon while flanking it","Type":"Melee","Usage":"At-Will","UsageDetails":null},{"Action":"Standard","Attacks":[{"AttackBonuses":{"Reflex":14},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"2d8 + 7","Description":"cold damage, and the target gains vulnerable 5 to all damage (save ends).","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"Half damage","FailedSavingThrows":[],"IsEmpty":false,"Name":"Miss","Sustains":[]},"Range":"Close blast 5","Targets":null}],"Flavor":null,"IsBasic":false,"Keywords":["Cold"],"Name":"Breath Weapon","Requirements":null,"Trigger":null,"Type":"Close","Usage":"Recharge","UsageDetails":"5"},{"Action":"Free","Attacks":[{"AttackBonuses":{},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"Breath weapon recharges, and the adult silver dragon uses it","FailedSavingThrows":[],"IsEmpty":false,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":null,"Targets":null}],"Flavor":null,"IsBasic":false,"Keywords":[],"Name":"Bloodied Breath","Requirements":null,"Trigger":"when first bloodied","Type":"Close","Usage":"Encounter","UsageDetails":null},{"Action":"Standard","Attacks":[{"AttackBonuses":{"Will":14},"Effect":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"","FailedSavingThrows":[],"IsEmpty":true,"Name":"Effect","Sustains":[]},"Hit":{"Action":null,"AfterEffects":[{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":"The target takes a -2 penalty to attack rolls (save ends)","FailedSavingThrows":[],"IsEmpty":false,"Name":"Aftereffect","Sustains":[]}],"Attacks":[],"Damage":"","Description":"the target is stunned until the end of the adult silver dragon’s next turn.","FailedSavingThrows":[],"IsEmpty":false,"Name":"Hit","Sustains":[]},"Miss":{"Action":null,"AfterEffects":[],"Attacks":[],"Damage":"","Description":null,"FailedSavingThrows":[],"IsEmpty":true,"Name":"Miss","Sustains":[]},"Range":"Close burst 5","Targets":"targets enemies"}],"Flavor":null,"IsBasic":false,"Keywords":["Fear"],"Name":"Frightful Presence","Requirements":null,"Trigger":null,"Type":"Close","Usage":"Encounter","UsageDetails":null}],"Regeneration":0,"Resistances":["20 Cold"],"Role":"Brute","SavingThrows":5,"Senses":[{"Key":"Darkvision","Value":0}],"SourceBook":"Monster Manual 2","SourceBooks":null,"Tactics":"","Traits":[{"Name":"Threatening Reach","Details":"An adult silver dragon can make opportunity attacks against all enemies within its reach (2 squares).","Keywords":[],"Range":0}],"Type":"Magical Beast","Weaknesses":[],"AbilityScores":{"Strength":28,"Constitution":24,"Dexterity":22,"Intelligence":12,"Wisdom":12,"Charisma":20},"ActionPoints":2,"Alignment":"Unaligned","Defenses":{"AC":27,"Fortitude":29,"Reflex":26,"Will":25},"Experience":6000,"Handle":"Adult Silver Dragon (Br15S)","HitPoints":608,"Initiative":13,"Speed":8,"Languages":["Common","Draconic"],"Level":15,"Name":"Adult Silver Dragon","Race":null,"Skills":{"Perception":13,"Athletics":21,"Insight":13},"Size":"Large"}';

function ViewModel() {
    var self = this;

    this.Bound = false;

    this.Monster = ko.observable();

    this.Bloodied = function () {
        return (self.Monster().HitPoints / 2).toFixed(0);
    };
    this.Skills = function () {
        return _.omit(self.Monster().Skills, 'Perception');
    };
    this.LevelString = function () {
        return 'Level ' + self.Monster().Level + ' ' + self.Monster().GroupRole + ' ' + self.Monster().Role;
    };
    this.TraitsString = function () {
        var prefix = self.Monster().Size + ' ' + self.Monster().Origin + ' ' + self.Monster().Type + ' ',
            keywords = self.Monster().Keywords.join(', ');

        if (keywords) {
            keywords = '(' + keywords + ')';
        }
        return prefix + keywords;
    };
}

// transform the ViewModel so that we can map our data to
// it each time renderStatBlock is called
window.vm = new ViewModel();
ko.bindingProvider.instance = new StringInterpolatingBindingProvider();

// externally invoked method to render a new StatBlock
function renderStatBlock(json) {
    var data = ko.utils.parseJson(json);
    window.vm.Monster(data);
    if (!vm.Bound) {
        vm.Bound = true;
        ko.applyBindings(window.vm);
    }
}

$(document).ready(function () {
   renderStatBlock(debugJson);
});
